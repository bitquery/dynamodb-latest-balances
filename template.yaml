AWSTemplateFormatVersion: '2010-09-09'
Description: 'Bitquery Token Stream Processor â€” Kafka â†’ DynamoDB'

Parameters:
  VpcId:
    Type: AWS::EC2::VPC::Id
  PublicSubnetId:
    Type: AWS::EC2::Subnet::Id
    Description: Public subnet (with IGW route + auto-assign public IP)
  KafkaConfigSsmName:
    Type: String
    Default: /bitquery/kafka-config
  ImageId:
    Type: AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>
    Default: /aws/service/canonical/ubuntu/server/22.04/stable/current/amd64/hvm/ebs-gp2/ami-id
  InstanceType:
    Type: String
    Default: t3.medium
    AllowedValues: [t3.medium, t3.large, m5.large, c5.large]
  ContainerImageTag:
    Type: String
    Default: latest
    Description: Docker image tag for dynamodb-latest-balances

Resources:
  ProcessorRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal: { Service: ec2.amazonaws.com }
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore  # Modern replacement
      Policies:
        - PolicyName: ProcessorPermissions
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:PutItem
                  - dynamodb:UpdateItem
                  - dynamodb:GetItem
                Resource: !GetAtt TokenBalancesTable.Arn

              - Effect: Allow
                Action: ssm:GetParameter
                Resource: !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter${KafkaConfigSsmName}"

              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource:
                  - !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:${LogGroup}:*"
                  - !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:${LogGroup}"

              # ðŸ”‘ Critical: ECR permissions
              - Effect: Allow
                Action: ecr:GetAuthorizationToken
                Resource: "*"  # Required â€” global action

              - Effect: Allow
                Action:
                  - ecr:BatchCheckLayerAvailability
                  - ecr:GetDownloadUrlForLayer
                  - ecr:BatchGetImage
                  - ecr:DescribeImages
                  - ecr:DescribeRepositories
                Resource: !Sub "arn:aws:ecr:${AWS::Region}:${AWS::AccountId}:repository/dynamodb-latest-balances"

  ProcessorInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles: [ !Ref ProcessorRole ]

  TokenBalancesTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: ethereum_eth_tx_balances
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: address
          AttributeType: S
      KeySchema:
        - AttributeName: address
          KeyType: HASH
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: false
      SSESpecification: { SSEEnabled: true }

  LogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "${AWS::StackName}-logs"
      RetentionInDays: 14

  SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: !Sub "${AWS::StackName} - outbound only"
      VpcId: !Ref VpcId   # â† must reference your VPC ID

  LaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateName: !Sub "${AWS::StackName}-lt"
      LaunchTemplateData:
        ImageId: !Ref ImageId
        InstanceType: !Ref InstanceType
        IamInstanceProfile: { Arn: !GetAtt ProcessorInstanceProfile.Arn }
        NetworkInterfaces:
          - AssociatePublicIpAddress: true
            DeviceIndex: 0
            SubnetId: !Ref PublicSubnetId
            Groups:
              - !GetAtt SecurityGroup.GroupId
        UserData:
          Fn::Base64: !Sub |
            #!/bin/bash -xe
            apt-get update
            apt-get install -y docker.io awscli
            systemctl enable --now docker
            REPO_NAME="dynamodb-latest-balances"
            ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
            REGION=${AWS::Region}
            REGISTRY="$ACCOUNT_ID.dkr.ecr.$REGION.amazonaws.com"
            REPO_URL="$REGISTRY/$REPO_NAME:${ContainerImageTag}"
            aws ecr get-login-password --region "$REGION" | docker login --username AWS --password-stdin "$REGISTRY"
            mkdir -p /app/config
            aws ssm get-parameter --name "${KafkaConfigSsmName}" --with-decryption --region "$REGION" --query Parameter.Value --output text > /app/config/kafka_config.yaml
            docker run --rm \
              -v /app/config:/app/config:ro \
              -e AWS_REGION=$REGION \
              --log-driver=awslogs \
              --log-opt awslogs-group=${LogGroup} \
              --log-opt awslogs-region=$REGION \
              --log-opt awslogs-stream=processor-$(date +%s) \
              $REPO_URL

  AutoScalingGroup:
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      AutoScalingGroupName: !Sub "${AWS::StackName}-asg"
      LaunchTemplate:
        LaunchTemplateId: !Ref LaunchTemplate
        Version: !GetAtt LaunchTemplate.LatestVersionNumber
      MinSize: "1"
      MaxSize: "1"
      DesiredCapacity: "1"
      VPCZoneIdentifier:
        - !Ref PublicSubnetId
      HealthCheckType: EC2
      HealthCheckGracePeriod: 300
    UpdatePolicy:
      AutoScalingRollingUpdate:
        MinInstancesInService: "0"
        MaxBatchSize: "1"
        PauseTime: PT0S
        WaitOnResourceSignals: false
        SuspendProcesses:
          - HealthCheck
          - ReplaceUnhealthy

  AlertTopic:
    Type: AWS::SNS::Topic
    Properties:
      DisplayName: !Sub "${AWS::StackName} Alerts"

Outputs:
  TableName:
    Value: !Ref TokenBalancesTable
    Export:
      Name: !Sub "${AWS::StackName}-TableName"
  LogGroupName:
    Value: !Ref LogGroup
  KafkaConfigParam:
    Value: !Ref KafkaConfigSsmName
  LaunchTemplateName:
    Value: !Ref LaunchTemplate

